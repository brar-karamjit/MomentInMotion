<!DOCTYPE html>
<html>
<head>
    <title>MomentInMotion</title>
    <style>
        body { font-family: Arial, sans-serif; max-width:700px; margin:20px auto; padding:10px; line-height:1.6; }
        h1 { color:#2c3e50; }
        button { padding:8px 16px; background-color:#3498db; color:white; border:none; border-radius:5px; cursor:pointer; }
        button:hover { background-color:#2980b9; }
        #temperature { font-weight:bold; }
        .suggestion { background-color:#f1f1f1; padding:10px; border-radius:5px; margin-top:10px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Welcome, {{ user.first_name }}!</h1>

    <p>Current weather: <span id="temperature">Not available</span></p>

    <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="lat" id="lat">
        <input type="hidden" name="lon" id="lon">
        <input type="hidden" name="temperature" id="temperature_input">
        <input type="hidden" name="weathercode" id="weather_text_input">
        <button type="submit" name="action" value="get_suggestion">Get Suggestion</button>
    </form>

    {% if suggestion_data %}
        <h2>Prompt sent to Gemini:</h2>
        <pre>{{ suggestion_data.prompt }}</pre>

        <h2>Suggestion received:</h2>
        <div class="suggestion">{{ suggestion_data.response|linebreaks }}</div>
    {% endif %}

    <script>
        const weatherEmoji = {
            0: "☀️ Clear", 1: "🌤️ Mainly clear", 2: "⛅ Partly cloudy", 3: "☁️ Cloudy",
            45: "🌫️ Fog", 48: "🌫️ Depositing rime fog", 51: "🌦️ Light drizzle",
            53: "🌦️ Moderate drizzle", 55: "🌦️ Dense drizzle", 61: "🌧️ Slight rain",
            63: "🌧️ Moderate rain", 65: "🌧️ Heavy rain", 71: "❄️ Slight snow",
            73: "❄️ Moderate snow", 75: "❄️ Heavy snow", 80: "🌦️ Rain showers",
            81: "🌦️ Moderate rain showers", 82: "🌧️ Violent rain showers",
            95: "⛈️ Thunderstorm", 96: "⛈️ Thunderstorm with slight hail", 99: "⛈️ Thunderstorm with heavy hail"
        };

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                document.getElementById('lat').value = lat;
                document.getElementById('lon').value = lon;

                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
                .then(resp => resp.json())
                .then(data => {
                    if (data.current_weather) {
                        const temp = data.current_weather.temperature;
                        const code = data.current_weather.weathercode;
                        const weatherText = weatherEmoji[code] || `Code ${code}`;
                        document.getElementById('temperature').innerText = `${temp}°C, ${weatherEmoji[code] || code}`;
                        document.getElementById('temperature_input').value = temp;
                        document.getElementById('weather_text_input').value = weatherText
                    }
                }).catch(err => console.error("Weather fetch error:", err));
            });
        }
    </script>
</body>
</html>
